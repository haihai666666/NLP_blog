<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>基于注意力机制实现机器翻译</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li></li>
<li>
<ul>
<li></li>
<li></li>
<li></li>
</ul>
</li>
<li>
<ul>
<li></li>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>
</li>
<li>
<ul>
<li></li>
<li></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <h1><a id="_0"></a>一.实验介绍</h1>
<p>近年来，随着深度学习技术的不断发展，自然语言处理（NLP）领域取得了显著进展。其中，注意力（Attention）机制在机器翻译领域的应用尤为突出。本文将介绍如何使用注意力机制实现机器翻译。<br>
机器翻译是指将一段文本从一种语言自动翻译到另一种语言。因为一段文本序列在不同语言中的长度不一定相同，所以我们使用机器翻译为例来介绍编码器—解码器和注意力机制的应用。</p>
<h1><a id="_3"></a>二.实验基本原理模型介绍</h1>
<h2><a id="21_seq2seq_4"></a>2.1 编码器—解码器（seq2seq）</h2>
<p>所谓的seq2seq模型就是我们常说的编码器-解码器架构，Encoder和Decoder层一般采用循环神经网络。<br>
模型结构图：<br>
<img src="https://img-blog.csdnimg.cn/direct/3eee64148a4e479e93cd87f5b0e51f81.png" alt="seq2seq模型结构图"><br>
编码器用来分析输入序列，解码器用来生成输出序列。在训练数据集中，我们可以在每个句子后附上特殊符号“”（end of sequence）以表示序列的终止。编码器每个时间步的输入依次为英语句子中的单词、标点和特殊符号“”。下面的图中使用了编码器在最终时间步的隐藏状态作为输入句子的表征或编码信息。解码器在各个时间步中使用输入句子的编码信息和上个时间步的输出以及隐藏状态作为输入。我们希望解码器在各个时间步能正确依次输出翻译后的法语单词、标点和特殊符号"“。需要注意的是，解码器在最初时间步的输入用到了一个表示序列开始的特殊符号”"（beginning of sequence）。<br>
<img src="https://img-blog.csdnimg.cn/direct/8bc294aa37414765951ec3bf3903c7e9.png" alt="在这里插入图片描述"></p>
<h3><a id="211_Encoder_10"></a>2.1.1 编码器（Encoder）</h3>
<p>编码器的作用是把一个不定长的输入序列变换成一个定长的背景变量<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">c</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4444em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span></span></span></span></span>，并在该背景变量中编码输入序列信息。常用的编码器是循环神经网络。</p>
<p>让我们考虑批量大小为1的时序数据样本。假设输入序列是<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">x_1,\ldots,x_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，例如<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">x_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>是输入句子中的第<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span></span>个词。在时间步<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span>，循环神经网络将输入<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">x_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>的特征向量<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">x</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{x}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5944em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和上个时间步的隐藏状态<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">h</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{h}_{t-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.9028em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span>变换为当前时间步的隐藏状态<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">h</mi><mi>t</mi></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{h}_t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>。我们可以用函数<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span></span></span></span></span>表达循环神经网络隐藏层的变换：</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold-italic">h</mi><mi>t</mi></msub><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">x</mi><mi>t</mi></msub><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">h</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">
\boldsymbol{h}_t = f(\boldsymbol{x}_t, \boldsymbol{h}_{t-1}).
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">x</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">.</span></span></span></span></span></span></p>
<p>接下来，编码器通过自定义函数<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span></span></span></span></span>将各个时间步的隐藏状态变换为背景变量</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="bold-italic">c</mi><mo>=</mo><mi>q</mi><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">h</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">h</mi><mi>T</mi></msub><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">
\boldsymbol{c} =  q(\boldsymbol{h}_1, \ldots, \boldsymbol{h}_T).
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4444em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">.</span></span></span></span></span></span></p>
<p>例如，当选择<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo stretchy="false">(</mo><msub><mi mathvariant="bold-italic">h</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">h</mi><mi>T</mi></msub><mo stretchy="false">)</mo><mo>=</mo><msub><mi mathvariant="bold-italic">h</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">q(\boldsymbol{h}_1, \ldots, \boldsymbol{h}_T) = \boldsymbol{h}_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">q</span><span class="mopen">(</span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>时，背景变量是输入序列最终时间步的隐藏状态<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">h</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{h}_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">h</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>。</p>
<p>以上描述的编码器是一个单向的循环神经网络，每个时间步的隐藏状态只取决于该时间步及之前的输入子序列。我们也可以使用双向循环神经网络构造编码器。在这种情况下，编码器每个时间步的隐藏状态同时取决于该时间步之前和之后的子序列（包括当前时间步的输入），并编码了整个序列的信息。<br>
<img src="https://img-blog.csdnimg.cn/direct/0ee3f3681dc14829a955003861d7d8de.png" alt="在这里插入图片描述"></p>
<h3><a id="222_Decoder_31"></a>2.2.2 解码器（Decoder）</h3>
<p>刚刚已经介绍，编码器输出的背景变量<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">c</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4444em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span></span></span></span></span>编码了整个输入序列<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub></mrow><annotation encoding="application/x-tex">x_1, \ldots, x_T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>的信息。给定训练样本中的输出序列<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">y_1, y_2, \ldots, y_{T'}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，对每个时间步<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">t'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>（符号与输入序列或编码器的时间步<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span></span>有区别），解码器输出<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">y_{t'}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>的条件概率将基于之前的输出序列<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">y_1,\ldots,y_{t'-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和背景变量<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">c</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4444em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span></span></span></span></span>，即<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo>∣</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi mathvariant="bold-italic">c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(y_{t'} \mid y_1, \ldots, y_{t'-1}, \boldsymbol{c})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span><span class="mclose">)</span></span></span></span></span>。</p>
<p>为此，我们可以使用另一个循环神经网络作为解码器。在输出序列的时间步<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup></mrow><annotation encoding="application/x-tex">t^\prime</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>，解码器将上一时间步的输出<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">y_{t^\prime-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span>以及背景变量<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">c</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4444em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span></span></span></span></span>作为输入，并将它们与上一时间步的隐藏状态<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">s</mi><mrow><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{s}_{t^\prime-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6528em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">s</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span>变换为当前时间步的隐藏状态<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">s</mi><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{s}_{t^\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5944em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">s</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>。因此，我们可以用函数<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>g</mi></mrow><annotation encoding="application/x-tex">g</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span></span></span></span></span>表达解码器隐藏层的变换：</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="bold-italic">s</mi><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup></msub><mo>=</mo><mi>g</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi mathvariant="bold-italic">c</mi><mo separator="true">,</mo><msub><mi mathvariant="bold-italic">s</mi><mrow><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">
\boldsymbol{s}_{t^\prime} = g(y_{t^\prime-1}, \boldsymbol{c}, \boldsymbol{s}_{t^\prime-1}).
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5944em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">s</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">s</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mord">.</span></span></span></span></span></span></p>
<p>有了解码器的隐藏状态后，我们可以使用自定义的输出层和softmax运算来计算<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup></msub><mo>∣</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi mathvariant="bold-italic">c</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">P(y_{t^\prime} \mid y_1, \ldots, y_{t^\prime-1}, \boldsymbol{c})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span><span class="mclose">)</span></span></span></span></span>，例如，基于当前时间步的解码器隐藏状态 <span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold-italic">s</mi><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">\boldsymbol{s}_{t^\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.5944em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord boldsymbol">s</span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>、上一时间步的输出<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub></mrow><annotation encoding="application/x-tex">y_{t^\prime-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span></span></span></span></span>以及背景变量<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold-italic">c</mi></mrow><annotation encoding="application/x-tex">\boldsymbol{c}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.4444em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span></span></span></span></span>来计算当前时间步输出<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><msup><mi>t</mi><mo mathvariant="normal">′</mo></msup></msub></mrow><annotation encoding="application/x-tex">y_{t^\prime}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>的概率分布。<br>
<img src="https://img-blog.csdnimg.cn/direct/36625a667c9542399c9514a4225019d1.png" alt="在这里插入图片描述"></p>
<h3><a id="223_EncoderDecoder_43"></a>2.2.3 Encoder-Decoder模型的训练</h3>
<p>根据最大似然估计，我们可以最大化输出序列基于输入序列的条件概率</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo>∣</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munderover><mo>∏</mo><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>1</mn></mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo>∣</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub><mo stretchy="false">)</mo></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><munderover><mo>∏</mo><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>1</mn></mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></munderover><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo>∣</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi mathvariant="bold-italic">c</mi><mo stretchy="false">)</mo><mo separator="true">,</mo></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
P(y_1, \ldots, y_{T'} \mid x_1, \ldots, x_T)
&amp;= \prod_{t'=1}^{T'} P(y_{t'} \mid y_1, \ldots, y_{t'-1}, x_1, \ldots, x_T)\\
&amp;= \prod_{t'=1}^{T'} P(y_{t'} \mid y_1, \ldots, y_{t'-1}, \boldsymbol{c}),
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 7.0469em; vertical-align: -3.2735em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.7735em;"><span class="" style="top: -5.7735em;"><span class="pstrut" style="height: 3.9295em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span><span class="" style="top: -2.25em;"><span class="pstrut" style="height: 3.9295em;"></span><span class="mord"></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 3.2735em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.7735em;"><span class="" style="top: -5.7735em;"><span class="pstrut" style="height: 3.9295em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.9295em;"><span class="" style="top: -1.856em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∏</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.294em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span><span class="" style="top: -2.25em;"><span class="pstrut" style="height: 3.9295em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.9295em;"><span class="" style="top: -1.856em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∏</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.294em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 3.2735em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>并得到该输出序列的损失</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo>−</mo><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo>∣</mo><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>T</mi></msub><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munderover><mo>∑</mo><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>1</mn></mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></munderover><mi>log</mi><mo>⁡</mo><mi>P</mi><mo stretchy="false">(</mo><msub><mi>y</mi><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo>∣</mo><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi mathvariant="bold-italic">c</mi><mo stretchy="false">)</mo><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">
-\log P(y_1, \ldots, y_{T'} \mid x_1, \ldots, x_T) = -\sum_{t'=1}^{T'} \log P(y_{t'} \mid y_1, \ldots, y_{t'-1}, \boldsymbol{c}),
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3283em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.2235em; vertical-align: -1.294em;"></span><span class="mord">−</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.9295em;"><span class="" style="top: -1.856em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span class="" style="top: -3.05em;"><span class="pstrut" style="height: 3.05em;"></span><span class=""><span class="mop op-symbol large-op">∑</span></span></span><span class="" style="top: -4.3em; margin-left: 0em;"><span class="pstrut" style="height: 3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.294em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mop">lo<span style="margin-right: 0.0139em;">g</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord"><span class="mord boldsymbol">c</span></span></span><span class="mclose">)</span><span class="mpunct">,</span></span></span></span></span></span></p>
<p>在模型训练中，所有输出序列损失的均值通常作为需要最小化的损失函数。在图10.8所描述的模型预测中，我们需要将解码器在上一个时间步的输出作为当前时间步的输入。与此不同，在训练中我们也可以将标签序列（训练集的真实输出序列）在上一个时间步的标签作为解码器在当前时间步的输入。这叫作强制教学（teacher forcing）。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/3e258c8740ab4f26937b4d19c4341fdd.png" alt="在这里插入图片描述"></p>
<h2><a id="22__64"></a>2.2 束搜索</h2>
<p>那么我们该如何使用编码器—解码器来预测不定长的序列？<br>
上面的内容提到，在准备训练数据集时，我们通常会在样本的输入序列和输出序列后面分别附上一个特殊符号"&lt;eos&gt;“表示序列的终止。我们在接下来的讨论中也将沿用上面全部数学符号。为了便于讨论，假设解码器的输出是一段文本序列。设输出文本词典<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">Y</mi></mrow><annotation encoding="application/x-tex">\mathcal{Y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7805em; vertical-align: -0.0972em;"></span><span class="mord mathcal" style="margin-right: 0.0822em;">Y</span></span></span></span></span>（包含特殊符号”&lt;eos&gt;“）的大小为<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo fence="true">∣</mo><mi mathvariant="script">Y</mi><mo fence="true">∣</mo></mrow><annotation encoding="application/x-tex">\left|\mathcal{Y}\right|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">∣</span><span class="mord mathcal" style="margin-right: 0.0822em;">Y</span><span class="mclose delimcenter" style="top: 0em;">∣</span></span></span></span></span></span>，输出序列的最大长度为<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">T'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>。所有可能的输出序列一共有<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mo fence="true">∣</mo><mi mathvariant="script">Y</mi><mo fence="true">∣</mo></mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\left|\mathcal{Y}\right|^{T'})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.3324em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top: 0em;">∣</span><span class="mord mathcal" style="margin-right: 0.0822em;">Y</span><span class="mclose delimcenter" style="top: 0em;">∣</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.0824em;"><span class="" style="top: -3.2029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>种。这些输出序列中所有特殊符号”&lt;eos&gt;"后面的子序列将被舍弃。</p>
<h3><a id="221__68"></a>2.2.1 贪婪搜索</h3>
<p>让我们先来看一个简单的解决方案：贪婪搜索（greedy search）。对于输出序列任一时间步<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">t'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>，我们从<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="script">Y</mi><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">|\mathcal{Y}|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">∣</span><span class="mord mathcal" style="margin-right: 0.0822em;">Y</span><span class="mord">∣</span></span></span></span></span>个词中搜索出条件概率最大的词</p>
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>y</mi><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msub><mo>=</mo><mi><munder><mo><mi mathvariant="normal">argmax</mi><mo>⁡</mo></mo><mrow><mi>y</mi><mo>∈</mo><mi mathvariant="script">Y</mi></mrow></munder></mi><mi>P</mi><mrow><mo fence="true">(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><msup><mi>t</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>−</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi>c</mi><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">
y _ { t ^ { \prime } } = \underset { y \in \mathcal { Y } } { \operatorname { argmax } } P \left( y | y _ { 1 } , \ldots , y _ { t ^ { \prime } - 1 } , c \right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.8249em; vertical-align: -1.0749em;"></span><span class="mord"><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.4306em;"><span class="" style="top: -2.1612em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span><span class="mrel mtight">∈</span><span class="mord mathcal mtight" style="margin-right: 0.0822em;">Y</span></span></span></span><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop"><span class="mop"><span class="mord mathrm">argmax</span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.0749em;"><span class=""></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right: 0.1389em;">P</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">(</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.6828em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2083em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">c</span><span class="mclose delimcenter" style="top: 0em;">)</span></span></span></span></span></span></span></p>
<p>作为输出。一旦搜索出"&lt;eos&gt;"符号，或者输出序列长度已经达到了最大长度<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">T'</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span>，便完成输出。</p>
<p><strong>优缺点</strong></p>
<ul>
<li>优点：<br>
实现简单，计算效率高，因为它不需要探索所有可能的输出序列路径。</li>
<li>缺点：<br>
可能陷入局部最优解，因为它每一步都只考虑当前最可能的词，忽略了全局最优序列的可能性。这意味着，即使后续有更优的选择，一旦某一步做出了非全局最佳的选择，就无法回头修正。<br>
对于具有多个合理解的情况，贪婪搜索可能无法找到最自然或最准确的翻译或回复。</li>
</ul>
<p>因此，尽管贪婪搜索因其高效性而常用作基准或初步探索，但在追求高质量输出时，研究者往往会采用更复杂的解码策略，如束搜索（Beam Search），它保留了多个可能的解并从中选择整体最优解。</p>
<h3><a id="222__85"></a>2.2.2 穷举搜索</h3>
<p>如果目标是得到最优输出序列，我们可以考虑穷举搜索（exhaustive search）：穷举所有可能的输出序列，输出条件概率最大的序列。</p>
<p>虽然穷举搜索可以得到最优输出序列，但它的计算开销<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><msup><mrow><mo fence="true">∣</mo><mi mathvariant="script">Y</mi><mo fence="true">∣</mo></mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\left|\mathcal{Y}\right|^{T'})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.3324em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top: 0em;">∣</span><span class="mord mathcal" style="margin-right: 0.0822em;">Y</span><span class="mclose delimcenter" style="top: 0em;">∣</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.0824em;"><span class="" style="top: -3.2029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8278em;"><span class="" style="top: -2.931em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>很容易过大。例如，当<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="script">Y</mi><mi mathvariant="normal">∣</mi><mo>=</mo><mn>10000</mn></mrow><annotation encoding="application/x-tex">|\mathcal{Y}|=10000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">∣</span><span class="mord mathcal" style="margin-right: 0.0822em;">Y</span><span class="mord">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">10000</span></span></span></span></span>且<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">T'=10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">10</span></span></span></span></span>时，我们将评估<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><msup><mn>0</mn><mn>10</mn></msup><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>40</mn></msup></mrow><annotation encoding="application/x-tex">10000^{10} = 10^{40}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord">1000</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">10</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">40</span></span></span></span></span></span></span></span></span></span></span></span></span>个序列：这几乎不可能完成。而贪婪搜索的计算开销是<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">O</mi><mo stretchy="false">(</mo><mrow><mo fence="true">∣</mo><mi mathvariant="script">Y</mi><mo fence="true">∣</mo></mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(\left|\mathcal{Y}\right|T')</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1.0019em; vertical-align: -0.25em;"></span><span class="mord mathcal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="minner"><span class="mopen delimcenter" style="top: 0em;">∣</span><span class="mord mathcal" style="margin-right: 0.0822em;">Y</span><span class="mclose delimcenter" style="top: 0em;">∣</span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>，通常显著小于穷举搜索的计算开销。例如，当<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi mathvariant="script">Y</mi><mi mathvariant="normal">∣</mi><mo>=</mo><mn>10000</mn></mrow><annotation encoding="application/x-tex">|\mathcal{Y}|=10000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord">∣</span><span class="mord mathcal" style="margin-right: 0.0822em;">Y</span><span class="mord">∣</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">10000</span></span></span></span></span>且<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>T</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">T'=10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7519em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7519em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">10</span></span></span></span></span>时，我们只需评估<span class="katex--inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10000</mn><mo>×</mo><mn>10</mn><mo>=</mo><mn>1</mn><msup><mn>0</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">10000\times10=10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">10000</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">10</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span>个序列。</p>
<h3><a id="223__89"></a>2.2.3 束搜索</h3>
<p>束搜索（Beam Search）是序列生成任务中一种改进的搜索策略，是对贪婪搜索的一个改进算法。尤其适用于Seq2Seq模型的解码阶段，以提高预测序列的质量。相比贪婪搜索每次只选择最可能的词，束搜索考虑了更多可能的路径，从而提高了找到全局最优解的机会。<br>
<strong>工作流程</strong></p>
<ul>
<li>
<p>初始化：与贪婪搜索相似，束搜索开始时也使用特殊标记（如）和编码器的最终状态初始化解码器。</p>
</li>
<li>
<p>扩展与评分：在每一步，解码器为当前状态下的每一个可能的下一个词生成概率分布。接着，基于当前的束内序列，对所有可能的扩展（当前序列加上每个可能的下一个词）进行评分。评分通常依据累积概率，即序列中每个词的生成概率乘积。</p>
</li>
<li>
<p>修剪与保留：根据累积概率对所有扩展序列排序，并保留前k个最佳序列作为下一时间步的候选，这里的k就是束宽。束宽决定了搜索的广度和计算成本之间的平衡，较大的k可以增加找到最优解的概率，但同时也增加了计算负担。</p>
</li>
<li>
<p>终止条件：搜索过程持续进行，直到所有保留的序列生成结束标记（如）或达到预设的最大输出长度。</p>
</li>
<li>
<p>选择最优序列：最后，从所有完成的序列中选择累积概率最高的序列作为最终输出。<br>
<img src="https://img-blog.csdnimg.cn/direct/9cd39eb5da5941d1b3652d6cfcac419a.png" alt="在这里插入图片描述"></p>
</li>
</ul>
<p><strong>优缺点</strong></p>
<ul>
<li>优点：<br>
提高了解码质量，因为考虑了多个可能的路径，减少了因局部最优选择导致的错误。<br>
可以通过调整束宽来平衡解码质量和计算资源消耗。</li>
<li>缺点：<br>
**  计算成本高于贪婪搜索，尤其是在大束宽或长序列情况下。<br>
**  仍然不能保证找到全局最优解，只是在有限的搜索空间内找到相对较好的解。<br>
**  需要设置合适的束宽，过小可能错过最优解，过大则增加计算复杂度。</li>
</ul>
<p>束搜索在许多自然语言处理任务中，如机器翻译、语音识别、文本摘要等，都展现出了优于贪婪搜索的性能，特别是在要求较高生成质量的应用场景中。</p>
<h2><a id="23__114"></a>2.3 注意力机制</h2>
<p>注意力机制(Attention Mechanism)是机器学习中的一种数据处理方法，广泛应用在自然语言处理、图像识别以及语音识别等各种不同类型的机器学习任务中。注意力机制（Attention Mechanism）是深度学习领域中，特别是在序列到序列（Seq2Seq）模型、图像描述生成等任务中引入的一种重要技术。它的核心思想是让模型在处理输入序列时，能够动态地、有选择性地关注输入的不同部分，而不是均匀对待所有输入。这对于处理长序列或者需要理解输入序列中某些关键信息的任务尤为重要。下面是注意力机制的基本概念和工作原理：</p>
<h3><a id="231_117"></a>2.3.1基本概念</h3>
<p>在传统的Seq2Seq模型中，编码器将输入序列编码成一个固定长度的向量，这个向量被解码器用来生成输出序列。然而，当输入序列很长时，单一的固定向量难以捕获所有必要的细节信息。注意力机制的引入解决了这一问题，它允许解码器在生成每一个输出词时，都能直接“查看”输入序列的不同部分，并赋予它们不同的权重（注意力权重），从而聚焦于与当前输出最相关的输入部分。<br>
<strong>注意注意力与普通解码器的区别：注意力机制通过对编码器所有时间步的隐藏状态做加权平均来得到背景变量</strong><br>
注意力机制对不同信息的关注程度（重要程度）由权值来体现，注意力机制可以视为查询矩阵(Query)、键(key)以及加权平均值构成了多层感知机(Multilayer Perceptron, MLP)。</p>
<p>注意力的思想，类似于寻址。给定Target中的某个元素Query，通过计算Query和各个Key的相似性或相关性，得到每个Key对应Value的权重系数，然后对Value进行加权求和，即得到最终的Attention数值。所以，本质上Attention机制是Source中元素的Value值进行加权求和，而Query和Key用来计算对应Value的权重系数。</p>
<p><img src="https://img-blog.csdnimg.cn/direct/62d7824b44824d71be5f61e2fcc1da97.png" alt="在这里插入图片描述"></p>
<blockquote>
<p>Source：由一系列的&lt;Key, Value&gt;键值对构成。<br>
Query：给定的Target元素；<br>
Key：Source中元素的Key值；<br>
Value：Source中元素的Value值；<br>
权重系数：Query与key的相似性或相关性，权重系数:<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>S</mi><mi>i</mi><mi>m</mi><mi>i</mi><mi>l</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>y</mi><mo stretchy="false">(</mo><mi>Q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi><mo separator="true">,</mo><mi>K</mi><mi>e</mi><mi>y</mi><mi>i</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">S i m i l a r i t y ( Q u e r y , K e y i )</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="mord mathnormal">imi</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right: 0.0359em;">ery</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">Key</span><span class="mord mathnormal">i</span><span class="mclose">)</span></span></span></span></span></span>Similarity(Query, Key_i)Similarity(Query,Keyi )；<br>
Attention Value：对Value值进行加权求和；</p>
</blockquote>
<p>根据注意力机制的原理可知，其计算公式如下：<span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mi>Q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi><mo separator="true">,</mo><mi>s</mi><mi>o</mi><mi>u</mi><mi>r</mi><mi>c</mi><mi>e</mi><mo stretchy="false">)</mo><mo>=</mo><mo>∑</mo><mi>S</mi><mi>i</mi><mi>m</mi><mi>i</mi><mi>l</mi><mi>a</mi><mi>r</mi><mi>i</mi><mi>t</mi><mi>y</mi><mo stretchy="false">(</mo><mi>Q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi><mo separator="true">,</mo><mi>K</mi><mi>e</mi><mi>y</mi><mi>i</mi><mo stretchy="false">)</mo><mo>∗</mo><mi>V</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mi>i</mi><mtext>​​</mtext></mrow><annotation encoding="application/x-tex">
Attention(Query,source)=  ∑Similarity(Query,Keyi)∗Valuei
​​</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right: 0.0359em;">ery</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal">so</span><span class="mord mathnormal">u</span><span class="mord mathnormal">rce</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.6em; vertical-align: -0.55em;"></span><span class="mop op-symbol large-op" style="position: relative; top: 0em;">∑</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0576em;">S</span><span class="mord mathnormal">imi</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right: 0.0359em;">ery</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">Key</span><span class="mord mathnormal">i</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">Va</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord mathnormal">i</span><span class="mord">​​</span></span></span></span></span></span><br>
Attention从大量信息中有选择地筛选出少量重要信息并聚焦到这些重要信息上，忽略大多不重要的信息。聚焦的过程体现在权重系数的计算上，权重越大，越聚焦在对应的Value值上，即权重代表了信息的重要性，而Value是其对应的信息。</p>
<h3><a id="232__136"></a>2.3.2 注意力机制的计算</h3>
<p>大多数方法采用的注意力机制计算过程可以细化为如下三个阶段。</p>
<p>三阶段的注意力机制计算流程：</p>
<ul>
<li>
<p>第一阶段，计算 Query和不同 Key 的相关性，即计算不同 Value 值的权重系数；<br>
常用的方法就是点积或缩放点积。<br>
<img src="https://img-blog.csdnimg.cn/direct/3d6c375d9e1240a19b67dc555c562561.png" alt="在这里插入图片描述"></p>
</li>
<li>
<p>第二阶段，对上一阶段的输出进行归一化处理，将数值的范围映射到 0 和 1 之间。<br>
根据产生方法的不同，第一阶段产生的分值的取值范围也不一样，第二阶段引入类似SoftMax的计算方式对第一阶段的得分就行数值转换。一方面，可以进行归一化，将原始计算分值整理成所有元素权重之和为1的概率分布；另一方面，通过SoftMax的内在机制更加突出重要元素的权重。即一般采用如下公式：<br>
<img src="https://img-blog.csdnimg.cn/direct/70b0190429694968bfd6de7901396d42.png" alt="在这里插入图片描述"></p>
</li>
<li>
<p>第三阶段，根据权重系数对Value进行加权求和，从而得到最终的注意力数值。<br>
<img src="https://img-blog.csdnimg.cn/direct/9e799628bc8b428598695c72e5f85387.png" alt="在这里插入图片描述"></p>
</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/direct/afcb911a832b4bfd87b64df0f52e2626.png" alt="在这里插入图片描述"></p>
<h3><a id="233__153"></a>2.3.3 注意力的种类</h3>
<ul>
<li>硬注意力机制(Hard-Attention)：硬注意力更加关注点，也就是图像中的每个点都可能延伸出注意力。同时，硬注意力是一个随机的预测过程，更强调动态变化。硬注意力是一个不可微的注意力，训练过程往往是通过增强学习(reinforcement learning) 来完成。</li>
<li>软注意力机制(Soft-Attention)： 软注意力更加关注区域或者通道，软注意力是确定性的注意力，学习完成后可以直接通过网络生成，最关键的地方是软注意力是可微的。可微的注意力可以通过神经网络计算梯度，通过前向传播和后向反馈来学习得到注意力的权重。软注意力是[0,1]间连续分布问题，用0到1的不同分值表示每个区域被关注的程度高低。</li>
</ul>
<p>本质上，注意力机制能够为表征中较有价值的部分分配较多的计算资源。这个有趣的想法自提出后得到了快速发展，特别是启发了依靠注意力机制来编码输入序列并解码出输出序列的变换器（Transformer）模型的设计 。变换器抛弃了卷积神经网络和循环神经网络的架构。它在计算效率上比基于循环神经网络的编码器—解码器模型通常更具明显优势。含注意力机制的变换器的编码结构在后来的BERT预训练模型中得以应用并令后者大放异彩：微调后的模型在多达11项自然语言处理任务中取得了当时最先进的结果。不久后，同样是基于变换器设计的GPT-2模型于新收集的语料数据集预训练后，在7个未参与训练的语言模型数据集上均取得了当时最先进的结果。除了自然语言处理领域，注意力机制还被广泛用于图像分类、自动图像描述、唇语解读以及语音识别。</p>
<h1><a id="_159"></a>三.机器翻译实验过程</h1>
<h2><a id="31__160"></a>3.1 读取和预处理数据</h2>
<p>我们要定义一些特殊符号。其中“”（padding）符号用来添加在较短序列后，直到每个序列等长，而“”和“”符号分别表示序列的开始和结束。<br>
定义辅助函数来实现对数据集的读取和处理：</p>
<pre><code class="prism language-python"><span class="token comment"># 将一个序列中所有的词记录在all_tokens中以便之后构造词典，然后在该序列后面添加PAD直到序列</span>
<span class="token comment"># 长度变为max_seq_len，然后将序列保存在all_seqs中</span>
<span class="token keyword">def</span> <span class="token function">process_one_seq</span><span class="token punctuation">(</span>seq_tokens<span class="token punctuation">,</span> all_tokens<span class="token punctuation">,</span> all_seqs<span class="token punctuation">,</span> max_seq_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
    all_tokens<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>seq_tokens<span class="token punctuation">)</span>
    seq_tokens <span class="token operator">+=</span> <span class="token punctuation">[</span>EOS<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>PAD<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max_seq_len <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>seq_tokens<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    all_seqs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>seq_tokens<span class="token punctuation">)</span>

<span class="token comment"># 使用所有的词来构造词典。并将所有序列中的词变换为词索引后构造Tensor</span>
<span class="token keyword">def</span> <span class="token function">build_data</span><span class="token punctuation">(</span>all_tokens<span class="token punctuation">,</span> all_seqs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    vocab <span class="token operator">=</span> Vocab<span class="token punctuation">.</span>Vocab<span class="token punctuation">(</span>collections<span class="token punctuation">.</span>Counter<span class="token punctuation">(</span>all_tokens<span class="token punctuation">)</span><span class="token punctuation">,</span>
                        specials<span class="token operator">=</span><span class="token punctuation">[</span>PAD<span class="token punctuation">,</span> BOS<span class="token punctuation">,</span> EOS<span class="token punctuation">]</span><span class="token punctuation">)</span>
    indices <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>vocab<span class="token punctuation">.</span>stoi<span class="token punctuation">[</span>w<span class="token punctuation">]</span> <span class="token keyword">for</span> w <span class="token keyword">in</span> seq<span class="token punctuation">]</span> <span class="token keyword">for</span> seq <span class="token keyword">in</span> all_seqs<span class="token punctuation">]</span>
    <span class="token keyword">return</span> vocab<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>indices<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">read_data</span><span class="token punctuation">(</span>max_seq_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># in和out分别是input和output的缩写</span>
    in_tokens<span class="token punctuation">,</span> out_tokens<span class="token punctuation">,</span> in_seqs<span class="token punctuation">,</span> out_seqs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">with</span> io<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'fr-en-small.txt'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>
        in_seq<span class="token punctuation">,</span> out_seq <span class="token operator">=</span> line<span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\t'</span><span class="token punctuation">)</span>
        in_seq_tokens<span class="token punctuation">,</span> out_seq_tokens <span class="token operator">=</span> in_seq<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">,</span> out_seq<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>in_seq_tokens<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>out_seq_tokens<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> max_seq_len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>  <span class="token comment"># 如果加上EOS后长于max_seq_len，则忽略掉此样本</span>
        process_one_seq<span class="token punctuation">(</span>in_seq_tokens<span class="token punctuation">,</span> in_tokens<span class="token punctuation">,</span> in_seqs<span class="token punctuation">,</span> max_seq_len<span class="token punctuation">)</span>
        process_one_seq<span class="token punctuation">(</span>out_seq_tokens<span class="token punctuation">,</span> out_tokens<span class="token punctuation">,</span> out_seqs<span class="token punctuation">,</span> max_seq_len<span class="token punctuation">)</span>
    in_vocab<span class="token punctuation">,</span> in_data <span class="token operator">=</span> build_data<span class="token punctuation">(</span>in_tokens<span class="token punctuation">,</span> in_seqs<span class="token punctuation">)</span>
    out_vocab<span class="token punctuation">,</span> out_data <span class="token operator">=</span> build_data<span class="token punctuation">(</span>out_tokens<span class="token punctuation">,</span> out_seqs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> in_vocab<span class="token punctuation">,</span> out_vocab<span class="token punctuation">,</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>in_data<span class="token punctuation">,</span> out_data<span class="token punctuation">)</span>
</code></pre>
<p>为了演示方便，我们在这里使用一个很小的法语—英语数据集。在这个数据集里，每一行是一对法语句子和它对应的英语句子，中间使用<code>'\t'</code>隔开。在读取数据时，我们在句末附上“&lt;eos&gt;”符号，并可能通过添加“&lt;pad&gt;”符号使每个序列的长度均为<code>max_seq_len</code>。我们为法语词和英语词分别创建词典。法语词的索引和英语词的索引相互独立。</p>
<h2><a id="32__196"></a>3.2 定义编码器和解码器架构</h2>
<h3><a id="321_Encoder_197"></a>3.2.1 编码器（Encoder）</h3>
<p>在编码器中，我们将输入语言的词索引通过词嵌入层得到词的表征，然后输入到一个多层门控循环单元中。下面我们来创建一个批量大小为4、时间步数为7的小批量序列输入，门控循环单元的隐藏层个数为2，隐藏单元个数为16的编码器。</p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Encoder</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vocab_size<span class="token punctuation">,</span> embed_size<span class="token punctuation">,</span> num_hiddens<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span>
                 drop_prob<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Encoder<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span>vocab_size<span class="token punctuation">,</span> embed_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rnn <span class="token operator">=</span> nn<span class="token punctuation">.</span>GRU<span class="token punctuation">(</span>embed_size<span class="token punctuation">,</span> num_hiddens<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span> dropout<span class="token operator">=</span>drop_prob<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 输入形状是(批量大小, 时间步数)。将输出互换样本维和时间步维</span>
        embedding <span class="token operator">=</span> self<span class="token punctuation">.</span>embedding<span class="token punctuation">(</span>inputs<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># (seq_len, batch, input_size)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>rnn<span class="token punctuation">(</span>embedding<span class="token punctuation">,</span> state<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">begin_state</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
encoder <span class="token operator">=</span> Encoder<span class="token punctuation">(</span>vocab_size<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> embed_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> num_hiddens<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>

</code></pre>
<h3><a id="322__220"></a>3.2.2 实现注意力机制</h3>
<p>注意力机制的输入包括查询项、键项和值项。设编码器和解码器的隐藏单元个数相同。这里的查询项为解码器在上一时间步的隐藏状态，形状为(批量大小, 隐藏单元个数)；键项和值项均为编码器在所有时间步的隐藏状态，形状为(时间步数, 批量大小, 隐藏单元个数)。注意力机制返回当前时间步的背景变量，形状为(批量大小, 隐藏单元个数)。</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">attention_forward</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> enc_states<span class="token punctuation">,</span> dec_state<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    enc_states: (时间步数, 批量大小, 隐藏单元个数)
    dec_state: (批量大小, 隐藏单元个数)
    """</span>
    <span class="token comment"># 将解码器隐藏状态广播到和编码器隐藏状态形状相同后进行连结</span>
    dec_states <span class="token operator">=</span> dec_state<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>expand_as<span class="token punctuation">(</span>enc_states<span class="token punctuation">)</span>
    enc_and_dec_states <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>enc_states<span class="token punctuation">,</span> dec_states<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    e <span class="token operator">=</span> model<span class="token punctuation">(</span>enc_and_dec_states<span class="token punctuation">)</span>  <span class="token comment"># 形状为(时间步数, 批量大小, 1)</span>
    alpha <span class="token operator">=</span> F<span class="token punctuation">.</span>softmax<span class="token punctuation">(</span>e<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 在时间步维度做softmax运算</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>alpha <span class="token operator">*</span> enc_states<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 返回背景变量</span>
</code></pre>
<h3><a id="323_Decoder_237"></a>3.2.3 解码器（Decoder）</h3>
<p>在解码器的前向计算中，我们先通过刚刚介绍的注意力机制计算得到当前时间步的背景向量。由于解码器的输入来自输出语言的词索引，我们将输入通过词嵌入层得到表征，然后和背景向量在特征维连结。我们将连结后的结果与上一时间步的隐藏状态通过门控循环单元计算出当前时间步的输出与隐藏状态。最后，我们将输出通过全连接层变换为有关各个输出词的预测，形状为(批量大小, 输出词典大小)。</p>
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Decoder</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vocab_size<span class="token punctuation">,</span> embed_size<span class="token punctuation">,</span> num_hiddens<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span>
                 attention_size<span class="token punctuation">,</span> drop_prob<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Decoder<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span>vocab_size<span class="token punctuation">,</span> embed_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>attention <span class="token operator">=</span> attention_model<span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>num_hiddens<span class="token punctuation">,</span> attention_size<span class="token punctuation">)</span>
        <span class="token comment"># GRU的输入包含attention输出的c和实际输入, 所以尺寸是 num_hiddens+embed_size</span>
        self<span class="token punctuation">.</span>rnn <span class="token operator">=</span> nn<span class="token punctuation">.</span>GRU<span class="token punctuation">(</span>num_hiddens <span class="token operator">+</span> embed_size<span class="token punctuation">,</span> num_hiddens<span class="token punctuation">,</span> 
                          num_layers<span class="token punctuation">,</span> dropout<span class="token operator">=</span>drop_prob<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>out <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_hiddens<span class="token punctuation">,</span> vocab_size<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> cur_input<span class="token punctuation">,</span> state<span class="token punctuation">,</span> enc_states<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        cur_input shape: (batch, )
        state shape: (num_layers, batch, num_hiddens)
        """</span>
        <span class="token comment"># 使用注意力机制计算背景向量</span>
        c <span class="token operator">=</span> attention_forward<span class="token punctuation">(</span>self<span class="token punctuation">.</span>attention<span class="token punctuation">,</span> enc_states<span class="token punctuation">,</span> state<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 将嵌入后的输入和背景向量在特征维连结, (批量大小, num_hiddens+embed_size)</span>
        input_and_c <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>embedding<span class="token punctuation">(</span>cur_input<span class="token punctuation">)</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span> 
        <span class="token comment"># 为输入和背景向量的连结增加时间步维，时间步个数为1</span>
        output<span class="token punctuation">,</span> state <span class="token operator">=</span> self<span class="token punctuation">.</span>rnn<span class="token punctuation">(</span>input_and_c<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span>
        <span class="token comment"># 移除时间步维，输出形状为(批量大小, 输出词典大小)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>out<span class="token punctuation">(</span>output<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> output<span class="token punctuation">,</span> state

    <span class="token keyword">def</span> <span class="token function">begin_state</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> enc_state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 直接将编码器最终时间步的隐藏状态作为解码器的初始隐藏状态</span>
        <span class="token keyword">return</span> enc_state
</code></pre>
<h2><a id="33__272"></a>3.3 模型迭代训练</h2>
<h3><a id="331__273"></a>3.3.1 实现批量损失的计算函数</h3>
<p>我们先实现<code>batch_loss</code>函数计算一个小批量的损失。</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">batch_loss</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> loss<span class="token punctuation">)</span><span class="token punctuation">:</span>
    batch_size <span class="token operator">=</span> X<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    enc_state <span class="token operator">=</span> encoder<span class="token punctuation">.</span>begin_state<span class="token punctuation">(</span><span class="token punctuation">)</span>
    enc_outputs<span class="token punctuation">,</span> enc_state <span class="token operator">=</span> encoder<span class="token punctuation">(</span>X<span class="token punctuation">,</span> enc_state<span class="token punctuation">)</span>
    <span class="token comment"># 初始化解码器的隐藏状态</span>
    dec_state <span class="token operator">=</span> decoder<span class="token punctuation">.</span>begin_state<span class="token punctuation">(</span>enc_state<span class="token punctuation">)</span>
    <span class="token comment"># 解码器在最初时间步的输入是BOS</span>
    dec_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>out_vocab<span class="token punctuation">.</span>stoi<span class="token punctuation">[</span>BOS<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">*</span> batch_size<span class="token punctuation">)</span>
    <span class="token comment"># 我们将使用掩码变量mask来忽略掉标签为填充项PAD的损失, 初始全1</span>
    mask<span class="token punctuation">,</span> num_not_pad_tokens <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span>
    l <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0.0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> y <span class="token keyword">in</span> Y<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment"># Y shape: (batch, seq_len)</span>
        dec_output<span class="token punctuation">,</span> dec_state <span class="token operator">=</span> decoder<span class="token punctuation">(</span>dec_input<span class="token punctuation">,</span> dec_state<span class="token punctuation">,</span> enc_outputs<span class="token punctuation">)</span>
        l <span class="token operator">=</span> l <span class="token operator">+</span> <span class="token punctuation">(</span>mask <span class="token operator">*</span> loss<span class="token punctuation">(</span>dec_output<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        dec_input <span class="token operator">=</span> y  <span class="token comment"># 使用强制教学</span>
        num_not_pad_tokens <span class="token operator">+=</span> mask<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># EOS后面全是PAD. 下面一行保证一旦遇到EOS接下来的循环中mask就一直是0</span>
        mask <span class="token operator">=</span> mask <span class="token operator">*</span> <span class="token punctuation">(</span>y <span class="token operator">!=</span> out_vocab<span class="token punctuation">.</span>stoi<span class="token punctuation">[</span>EOS<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> l <span class="token operator">/</span> num_not_pad_tokens
</code></pre>
<h3><a id="332__297"></a>3.3.2 定义训练函数创建模型示例开始训练</h3>
<p>在训练函数中，我们需要同时迭代编码器和解码器的模型参数。</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> dataset<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    enc_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>encoder<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>
    dec_optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>decoder<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>

    loss <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span>reduction<span class="token operator">=</span><span class="token string">'none'</span><span class="token punctuation">)</span>
    data_iter <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        l_sum <span class="token operator">=</span> <span class="token number">0.0</span>
        <span class="token keyword">for</span> X<span class="token punctuation">,</span> Y <span class="token keyword">in</span> data_iter<span class="token punctuation">:</span>
            enc_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            dec_optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            l <span class="token operator">=</span> batch_loss<span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> loss<span class="token punctuation">)</span>
            l<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            enc_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            dec_optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
            l_sum <span class="token operator">+=</span> l<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"epoch %d, loss %.3f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> l_sum <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data_iter<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

embed_size<span class="token punctuation">,</span> num_hiddens<span class="token punctuation">,</span> num_layers <span class="token operator">=</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">2</span>
attention_size<span class="token punctuation">,</span> drop_prob<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> num_epochs <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">50</span>
encoder <span class="token operator">=</span> Encoder<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>in_vocab<span class="token punctuation">)</span><span class="token punctuation">,</span> embed_size<span class="token punctuation">,</span> num_hiddens<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span>
                  drop_prob<span class="token punctuation">)</span>
decoder <span class="token operator">=</span> Decoder<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>out_vocab<span class="token punctuation">)</span><span class="token punctuation">,</span> embed_size<span class="token punctuation">,</span> num_hiddens<span class="token punctuation">,</span> num_layers<span class="token punctuation">,</span>
                  attention_size<span class="token punctuation">,</span> drop_prob<span class="token punctuation">)</span>
train<span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> dataset<span class="token punctuation">,</span> lr<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> num_epochs<span class="token punctuation">)</span>
</code></pre>
<p>训练过程如下：<br>
<img src="https://img-blog.csdnimg.cn/direct/6a1b4e4fb4364864b249bc4cec18450e.png" alt="在这里插入图片描述"></p>
<h2><a id="34__329"></a>3.4 模型测试并评价结果</h2>
<p>之前我们介绍了3种方法来生成解码器在每个时间步的输出。这里我们实现最简单的贪婪搜索。</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">translate</span><span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> input_seq<span class="token punctuation">,</span> max_seq_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
    in_tokens <span class="token operator">=</span> input_seq<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span>
    in_tokens <span class="token operator">+=</span> <span class="token punctuation">[</span>EOS<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>PAD<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max_seq_len <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>in_tokens<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
    enc_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>in_vocab<span class="token punctuation">.</span>stoi<span class="token punctuation">[</span>tk<span class="token punctuation">]</span> <span class="token keyword">for</span> tk <span class="token keyword">in</span> in_tokens<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># batch=1</span>
    enc_state <span class="token operator">=</span> encoder<span class="token punctuation">.</span>begin_state<span class="token punctuation">(</span><span class="token punctuation">)</span>
    enc_output<span class="token punctuation">,</span> enc_state <span class="token operator">=</span> encoder<span class="token punctuation">(</span>enc_input<span class="token punctuation">,</span> enc_state<span class="token punctuation">)</span>
    dec_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>out_vocab<span class="token punctuation">.</span>stoi<span class="token punctuation">[</span>BOS<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    dec_state <span class="token operator">=</span> decoder<span class="token punctuation">.</span>begin_state<span class="token punctuation">(</span>enc_state<span class="token punctuation">)</span>
    output_tokens <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_seq_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
        dec_output<span class="token punctuation">,</span> dec_state <span class="token operator">=</span> decoder<span class="token punctuation">(</span>dec_input<span class="token punctuation">,</span> dec_state<span class="token punctuation">,</span> enc_output<span class="token punctuation">)</span>
        pred <span class="token operator">=</span> dec_output<span class="token punctuation">.</span>argmax<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        pred_token <span class="token operator">=</span> out_vocab<span class="token punctuation">.</span>itos<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span>pred<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> pred_token <span class="token operator">==</span> EOS<span class="token punctuation">:</span>  <span class="token comment"># 当任一时间步搜索出EOS时，输出序列即完成</span>
            <span class="token keyword">break</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            output_tokens<span class="token punctuation">.</span>append<span class="token punctuation">(</span>pred_token<span class="token punctuation">)</span>
            dec_input <span class="token operator">=</span> pred
    <span class="token keyword">return</span> output_tokens


input_seq <span class="token operator">=</span> <span class="token string">'ils regardent .'</span>
translate<span class="token punctuation">(</span>encoder<span class="token punctuation">,</span> decoder<span class="token punctuation">,</span> input_seq<span class="token punctuation">,</span> max_seq_len<span class="token punctuation">)</span>
</code></pre>
<p>简单测试一下模型。输入法语句子“ils regardent.”，翻译后的英语句子应该是“they are watching.”。<br>
测试结果：<br>
<img src="https://img-blog.csdnimg.cn/direct/1cac6d80d5214b45a236a74e2dfd2216.png" alt="在这里插入图片描述"></p>
<h2><a id="35_Transformer_360"></a>3.5 基于Transformer实现机器翻译（日译中）</h2>
<h3><a id="351__361"></a>3.5.1 引入必要的工具包以及数据集获取</h3>
<p>首先，我们要确保系统中已安装以下包。如果发现缺少某些包，请务必安装它们。<br>
代码如下：</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> math
<span class="token keyword">import</span> torchtext
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> torch <span class="token keyword">import</span> Tensor
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>rnn <span class="token keyword">import</span> pad_sequence
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">from</span> collections <span class="token keyword">import</span> Counter
<span class="token keyword">from</span> torchtext<span class="token punctuation">.</span>vocab <span class="token keyword">import</span> Vocab
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">import</span> TransformerEncoder<span class="token punctuation">,</span> TransformerDecoder<span class="token punctuation">,</span> TransformerEncoderLayer<span class="token punctuation">,</span> TransformerDecoderLayer
<span class="token keyword">import</span> io
<span class="token keyword">import</span> time
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> tqdm
<span class="token keyword">import</span> sentencepiece <span class="token keyword">as</span> spm
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment"># 定义随机种子</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
<span class="token comment"># print(torch.cuda.get_device_name(0)) ## 如果你有GPU，请在你自己的电脑上尝试运行这一套代码</span>
</code></pre>
<p>在本教程中，我们将使用的日英平行数据集来源于JParaCrawl，<a href="http://www.kecl.ntt.co.jp/icl/lirg/jparacrawl">数据集</a>该数据集被描述为“由NTT创建的最大的公开可用的日英平行语料库。它是通过大规模网络爬取并自动对齐平行句子的方式构建的。” 相关论文可在此处查阅。<br>
数据集获取：</p>
<pre><code class="prism language-python">df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'./zh-ja/zh-ja.bicleaner05.txt'</span><span class="token punctuation">,</span> sep<span class="token operator">=</span><span class="token string">'\\t'</span><span class="token punctuation">,</span> engine<span class="token operator">=</span><span class="token string">'python'</span><span class="token punctuation">,</span> header<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span>
trainen <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#[:10000]</span>
trainja <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#[:10000]</span>
<span class="token comment"># trainen.pop(5972)</span>
<span class="token comment"># trainja.pop(5972)</span>
</code></pre>
<p>在导入所有日语及其对应的英语句子后，我删除了数据集中最后一项含有缺失值的记录。目前，trainen（英语训练集）和trainja（日语训练集）中的句子总数合计为5,973,071句。然而，为了确保学习过程顺畅且节约时间，通常建议先对数据进行抽样，检验一切是否按预期工作，之后再使用全部数据进行训练。这样做的目的是在大规模投入资源前，通过小规模数据验证模型的配置、代码逻辑以及整个流程是否正确无误。</p>
<p>打印数据示例如下：</p>
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>trainen<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>trainja<span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
<p>输出结果：<br>
<img src="https://img-blog.csdnimg.cn/direct/3f39ce8058f149ed89dcabf438ddf0e9.png" alt="在这里插入图片描述"></p>
<h3><a id="352__408"></a>3.5.2 构建分词器和词汇表</h3>
<p>与英语或其他字母语言不同，日语句子中并没有空格来分隔单词。我们可以使用JParaCrawl提供的分词器，这些分词器针对日语和英语都采用了SentencePiece技术进行创建。你可以访问JParaCrawl的官方网站下载这些分词器，或者直接点击此处进行获取。</p>
<p>SentencePiece是一种流行的文本处理工具，尤其适合处理像日语这样的没有自然空格分隔的语言。它通过统计方法将文本切分成子词单元（tokens），这些单元可以是字符、子词或整个词，具体取决于训练数据和设置。使用JParaCrawl提供的基于SentencePiece的分词模型，可以帮助我们高效且准确地对日英双语文本进行分词，为后续的自然语言处理任务，比如机器翻译，打下基础。</p>
<pre><code class="prism language-python">en_tokenizer <span class="token operator">=</span> spm<span class="token punctuation">.</span>SentencePieceProcessor<span class="token punctuation">(</span>model_file<span class="token operator">=</span><span class="token string">'enja_spm_models/spm.en.nopretok.model'</span><span class="token punctuation">)</span>
ja_tokenizer <span class="token operator">=</span> spm<span class="token punctuation">.</span>SentencePieceProcessor<span class="token punctuation">(</span>model_file<span class="token operator">=</span><span class="token string">'enja_spm_models/spm.ja.nopretok.model'</span><span class="token punctuation">)</span>
</code></pre>
<p>在加载分词器之后，你可以通过运行以下类似的代码来测试它们的功能。</p>
<pre><code class="prism language-python">en_tokenizer<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"All residents aged 20 to 59 years who live in Japan must enroll in public pension system."</span><span class="token punctuation">,</span> out_type<span class="token operator">=</span><span class="token string">'str'</span><span class="token punctuation">)</span>
ja_tokenizer<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"年金 日本に住んでいる20歳~60歳の全ての人は、公的年金制度に加入しなければなりません。"</span><span class="token punctuation">,</span> out_type<span class="token operator">=</span><span class="token string">'str'</span><span class="token punctuation">)</span>
</code></pre>
<p>测试结果如下：</p>
<p>待补充</p>
<ul>
<li>构建TorchText词汇表及将句子转换为Torch张量</li>
</ul>
<p>使用分词器和原始句子，接下来我们构建来自TorchText的词汇表（Vocab）对象。此过程可能需要几秒钟到几分钟的时间，具体取决于数据集的大小和计算能力。不同的分词器也会影响构建词汇表所需的时间，我尝试了几种其他适用于日语的分词器，但SentencePiece似乎工作得既好又快速，对我来说足够了。于是，我们将句子转换为Torch张量，以便神经网络模型能够直接处理这些数据。</p>
<p>构建词汇表之后，我们需要将原始的句子数据转换为Torch张量（Tensors）。这是深度学习模型训练所必需的，因为模型不能直接理解或操作文本字符串，而需要数值型输入。转换过程包括将每个句子中每个单词的索引（从词汇表中获得）编码为整数序列，然后这些整数序列可以被转换成PyTorch的张量形式，用于后续的模型输入。</p>
<pre><code class="prism language-python"><span class="token comment"># 定义一个构建词汇表的函数</span>
<span class="token keyword">def</span> <span class="token function">build_vocab</span><span class="token punctuation">(</span>sentences<span class="token punctuation">,</span> tokenizer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 使用Counter来计数句子中各个token的出现频率</span>
    counter <span class="token operator">=</span> Counter<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 遍历所有句子</span>
    <span class="token keyword">for</span> sentence <span class="token keyword">in</span> sentences<span class="token punctuation">:</span>
        <span class="token comment"># 使用tokenizer对句子进行编码，并更新到counter中，out_type=str确保计数的是字符串形式的token</span>
        counter<span class="token punctuation">.</span>update<span class="token punctuation">(</span>tokenizer<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>sentence<span class="token punctuation">,</span> out_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 根据counter创建词汇表实例，同时包含特殊符号：未知词('&lt;unk&gt;')、填充符('&lt;pad&gt;')、句首发('&lt;bos&gt;')、句尾符('&lt;eos&gt;')</span>
    <span class="token keyword">return</span> Vocab<span class="token punctuation">(</span>counter<span class="token punctuation">,</span> specials<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'&lt;unk&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&lt;pad&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&lt;bos&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&lt;eos&gt;'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 利用定义的函数为日语文本数据（trainja）构建词汇表</span>
ja_vocab <span class="token operator">=</span> build_vocab<span class="token punctuation">(</span>trainja<span class="token punctuation">,</span> ja_tokenizer<span class="token punctuation">)</span>

<span class="token comment"># 同样，为英语文本数据（trainen）构建词汇表</span>
en_vocab <span class="token operator">=</span> build_vocab<span class="token punctuation">(</span>trainen<span class="token punctuation">,</span> en_tokenizer<span class="token punctuation">)</span>
</code></pre>
<p>在我们拥有词汇表对象之后，就可以利用这些词汇表和分词器对象来为训练数据构建张量了。具体做法是，首先使用分词器将每条原始文本分割成单词或子词的序列，然后依据词汇表中每个单词或子词的索引，将这些序列转换成整数序列。最后，将这些整数序列封装成PyTorch的张量格式，这样我们的深度学习模型就能直接处理这些数值化的文本数据，进行诸如机器翻译、文本分类或情感分析等自然语言处理任务的训练。这个过程确保了数据的高效表示，同时便于模型理解和运算。</p>
<h3><a id="353__451"></a>3.5.3 创建数据加载器对象</h3>
<p>在这里，我将BATCH_SIZE设置为16，以防“CUDA内存不足”的情况发生，但这一设置取决于多种因素，比如你的机器内存容量、数据大小等，因此请根据实际情况自由调整批处理大小（注：PyTorch的官方教程在使用Multi30k德英数据集时将批处理大小设置为了128。）</p>
<p>在进行深度学习模型训练时，创建一个数据加载器（DataLoader）是非常关键的步骤。数据加载器的作用是从数据集中按批次取出数据，并提供给模型进行训练，同时它还可以实现数据的随机打乱、数据加载的多线程加速等功能，从而提高训练效率。通过调整BATCH_SIZE，我们可以控制每次送入模型进行训练的样本数量，较小的批尺寸有助于减少内存消耗，但可能增加训练时间；较大的批尺寸则能加速训练过程，但需更多内存支持。因此，选择合适的批尺寸是一个权衡内存使用和训练效率的过程。在实际应用中，确实需要根据个人电脑或服务器的具体硬件配置以及数据集的特性来灵活设定。</p>
<pre><code class="prism language-python"><span class="token comment"># 设置批次大小</span>
BATCH_SIZE <span class="token operator">=</span> <span class="token number">8</span>
<span class="token comment"># 获取Padding、开始（BOS）和结束（EOS）符号在词汇表中的索引</span>
PAD_IDX <span class="token operator">=</span> ja_vocab<span class="token punctuation">[</span><span class="token string">'&lt;pad&gt;'</span><span class="token punctuation">]</span>  <span class="token comment"># Padding符号的索引</span>
BOS_IDX <span class="token operator">=</span> ja_vocab<span class="token punctuation">[</span><span class="token string">'&lt;bos&gt;'</span><span class="token punctuation">]</span>  <span class="token comment"># 开始符号的索引</span>
EOS_IDX <span class="token operator">=</span> ja_vocab<span class="token punctuation">[</span><span class="token string">'&lt;eos&gt;'</span><span class="token punctuation">]</span>  <span class="token comment"># 结束符号的索引</span>

<span class="token comment"># 定义生成批次数据的函数</span>
<span class="token keyword">def</span> <span class="token function">generate_batch</span><span class="token punctuation">(</span>data_batch<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 初始化两个空列表，分别用于存放本批次的日语和英语数据</span>
    ja_batch<span class="token punctuation">,</span> en_batch <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment"># 遍历当前批次中的每一对日英句子数据</span>
    <span class="token keyword">for</span> japanese_item<span class="token punctuation">,</span> english_item <span class="token keyword">in</span> data_batch<span class="token punctuation">:</span>
        <span class="token comment"># 对每条日语文本，在句首添加开始符号（BOS），句尾添加结束符号（EOS），然后使用torch.cat拼接起来</span>
        ja_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>BOS_IDX<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> japanese_item<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>EOS_IDX<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 对应地，对每条英语文本也执行相同的处理</span>
        en_batch<span class="token punctuation">.</span>append<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>BOS_IDX<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> english_item<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span><span class="token punctuation">[</span>EOS_IDX<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 使用pad_sequence函数对处理后的日语和英语序列进行填充，确保每个batch内的序列长度一致，填充的值为PAD_IDX</span>
    ja_batch <span class="token operator">=</span> pad_sequence<span class="token punctuation">(</span>ja_batch<span class="token punctuation">,</span> padding_value<span class="token operator">=</span>PAD_IDX<span class="token punctuation">)</span>
    en_batch <span class="token operator">=</span> pad_sequence<span class="token punctuation">(</span>en_batch<span class="token punctuation">,</span> padding_value<span class="token operator">=</span>PAD_IDX<span class="token punctuation">)</span>
    <span class="token comment"># 返回填充后的日语和英语批次数据</span>
    <span class="token keyword">return</span> ja_batch<span class="token punctuation">,</span> en_batch

<span class="token comment"># 使用DataLoader创建迭代器，用于训练数据的加载</span>
<span class="token comment"># 指定批次大小、是否随机打乱数据、以及自定义的生成批次数据函数</span>
train_iter <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>BATCH_SIZE<span class="token punctuation">,</span>
                        shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> collate_fn<span class="token operator">=</span>generate_batch<span class="token punctuation">)</span>
</code></pre>
<h3><a id="354_Transformer_485"></a>3.5.4 构建序列到序列的Transformer模型</h3>
<p>Transformer是一种序列到序列（Seq2Seq）模型，它是在《注意力就是你所需要的》这篇论文中首次提出的，旨在解决机器翻译任务。Transformer模型由编码器（Encoder）和解码器（Decoder）两部分组成，每一部分都含有固定数量的层。</p>
<p>编码器通过一系列的多头注意力（Multi-head Attention）和前馈网络（Feed Forward network）层来处理输入序列。编码器的输出，即所谓的记忆（memory），会被传递给解码器，同时解码器也会接收到目标序列的信息。编码器和解码器采用端到端的方式进行联合训练，其中使用了教师强迫（teacher forcing）技术，即在训练过程中，解码器的每一步都直接使用真实的前一时刻输出作为输入，而非模型预测的输出，以此来加速并稳定训练过程。</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn

<span class="token keyword">class</span> <span class="token class-name">Seq2SeqTransformer</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_encoder_layers<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> num_decoder_layers<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 emb_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> src_vocab_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> tgt_vocab_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
                 dim_feedforward<span class="token punctuation">:</span><span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">512</span><span class="token punctuation">,</span> dropout<span class="token punctuation">:</span><span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        序列到序列（Seq2Seq）的Transformer模型初始化方法。
        
        参数:
        - num_encoder_layers: 编码器中的层数
        - num_decoder_layers: 解码器中的层数
        - emb_size: 词嵌入的维度
        - src_vocab_size: 源语言词汇表大小
        - tgt_vocab_size: 目标语言词汇表大小
        - dim_feedforward: 前馈网络的维度，默认为512
        - dropout: Dropout比例，默认为0.1
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Seq2SeqTransformer<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 定义编码器层</span>
        encoder_layer <span class="token operator">=</span> TransformerEncoderLayer<span class="token punctuation">(</span>d_model<span class="token operator">=</span>emb_size<span class="token punctuation">,</span> nhead<span class="token operator">=</span>NHEAD<span class="token punctuation">,</span> dim_feedforward<span class="token operator">=</span>dim_feedforward<span class="token punctuation">)</span>
        <span class="token comment"># 使用定义的层构建编码器</span>
        self<span class="token punctuation">.</span>transformer_encoder <span class="token operator">=</span> TransformerEncoder<span class="token punctuation">(</span>encoder_layer<span class="token punctuation">,</span> num_layers<span class="token operator">=</span>num_encoder_layers<span class="token punctuation">)</span>
        
        <span class="token comment"># 同样定义解码器层</span>
        decoder_layer <span class="token operator">=</span> TransformerDecoderLayer<span class="token punctuation">(</span>d_model<span class="token operator">=</span>emb_size<span class="token punctuation">,</span> nhead<span class="token operator">=</span>NHEAD<span class="token punctuation">,</span> dim_feedforward<span class="token operator">=</span>dim_feedforward<span class="token punctuation">)</span>
        <span class="token comment"># 构建解码器</span>
        self<span class="token punctuation">.</span>transformer_decoder <span class="token operator">=</span> TransformerDecoder<span class="token punctuation">(</span>decoder_layer<span class="token punctuation">,</span> num_layers<span class="token operator">=</span>num_decoder_layers<span class="token punctuation">)</span>
        
        <span class="token comment"># 生成器用于从模型输出映射到目标词汇表</span>
        self<span class="token punctuation">.</span>generator <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>emb_size<span class="token punctuation">,</span> tgt_vocab_size<span class="token punctuation">)</span>
        <span class="token comment"># 源语言和目标语言的词嵌入层</span>
        self<span class="token punctuation">.</span>src_tok_emb <span class="token operator">=</span> TokenEmbedding<span class="token punctuation">(</span>src_vocab_size<span class="token punctuation">,</span> emb_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>tgt_tok_emb <span class="token operator">=</span> TokenEmbedding<span class="token punctuation">(</span>tgt_vocab_size<span class="token punctuation">,</span> emb_size<span class="token punctuation">)</span>
        <span class="token comment"># 位置编码层，为序列中的每个位置提供一个固定的向量</span>
        self<span class="token punctuation">.</span>positional_encoding <span class="token operator">=</span> PositionalEncoding<span class="token punctuation">(</span>emb_size<span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> src<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> trg<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> src_mask<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span>
                tgt_mask<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> src_padding_mask<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span>
                tgt_padding_mask<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> memory_key_padding_mask<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        模型前向传播过程。
        
        参数:
        - src: 源语言输入序列
        - trg: 目标语言输入序列
        - src_mask: 源语言自注意力的掩码
        - tgt_mask: 目标语言自注意力的掩码
        - src_padding_mask: 源语言序列的Padding掩码
        - tgt_padding_mask: 目标语言序列的Padding掩码
        - memory_key_padding_mask: 编码器输出用于解码器的Padding掩码
        """</span>
        <span class="token comment"># 对源语言和目标语言序列应用词嵌入和位置编码</span>
        src_emb <span class="token operator">=</span> self<span class="token punctuation">.</span>positional_encoding<span class="token punctuation">(</span>self<span class="token punctuation">.</span>src_tok_emb<span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span>
        tgt_emb <span class="token operator">=</span> self<span class="token punctuation">.</span>positional_encoding<span class="token punctuation">(</span>self<span class="token punctuation">.</span>tgt_tok_emb<span class="token punctuation">(</span>trg<span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 通过编码器生成记忆向量</span>
        memory <span class="token operator">=</span> self<span class="token punctuation">.</span>transformer_encoder<span class="token punctuation">(</span>src_emb<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> src_padding_mask<span class="token punctuation">)</span>
        
        <span class="token comment"># 通过解码器生成输出序列</span>
        outs <span class="token operator">=</span> self<span class="token punctuation">.</span>transformer_decoder<span class="token punctuation">(</span>tgt_emb<span class="token punctuation">,</span> memory<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                                        tgt_padding_mask<span class="token punctuation">,</span> memory_key_padding_mask<span class="token punctuation">)</span>
        
        <span class="token comment"># 通过线性层映射到目标词汇表大小，得到预测输出</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>generator<span class="token punctuation">(</span>outs<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">encode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> src<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> src_mask<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        单独执行编码器部分。
        """</span>
        <span class="token comment"># 接受源语言序列和掩码，返回编码器的输出</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>transformer_encoder<span class="token punctuation">(</span>self<span class="token punctuation">.</span>positional_encoding<span class="token punctuation">(</span>self<span class="token punctuation">.</span>src_tok_emb<span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> src_mask<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">decode</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tgt<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> memory<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        给定目标语言序列、编码器的输出记忆以及目标语言掩码，执行解码器部分。
        """</span>
        <span class="token comment"># 生成解码器的输出</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>transformer_decoder<span class="token punctuation">(</span>self<span class="token punctuation">.</span>positional_encoding<span class="token punctuation">(</span>self<span class="token punctuation">.</span>tgt_tok_emb<span class="token punctuation">(</span>tgt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> memory<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span>
</code></pre>
<p>文本中的词元通过词嵌入（token embeddings）来表示。为了引入词序的概念，会在词嵌入的基础上加入位置编码（positional encoding）。</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> math

<span class="token keyword">class</span> <span class="token class-name">PositionalEncoding</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    位置编码类，为输入序列中的每个位置生成一个固定长度的向量，以帮助模型理解序列中不同位置的信息。
    
    参数:
    - emb_size: 词嵌入维度
    - dropout: Dropout比率，用于防止过拟合
    - maxlen: 最大序列长度，默认为5000
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> emb_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> dropout<span class="token punctuation">,</span> maxlen<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PositionalEncoding<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 计算位置编码中sin和cos使用的denominator</span>
        den <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> emb_size<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span> <span class="token operator">/</span> emb_size<span class="token punctuation">)</span>
        <span class="token comment"># 初始化位置序列（从0到maxlen-1）</span>
        pos <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> maxlen<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>maxlen<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 初始化位置嵌入矩阵</span>
        pos_embedding <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>maxlen<span class="token punctuation">,</span> emb_size<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 奇数索引对应sin函数值，偶数索引对应cos函数值</span>
        pos_embedding<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>pos <span class="token operator">*</span> den<span class="token punctuation">)</span>
        pos_embedding<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>pos <span class="token operator">*</span> den<span class="token punctuation">)</span>
        <span class="token comment"># 为后续广播加一维</span>
        pos_embedding <span class="token operator">=</span> pos_embedding<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 定义Dropout层</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>
        <span class="token comment"># 注册缓冲区，用于存储位置嵌入矩阵（不会被优化）</span>
        self<span class="token punctuation">.</span>register_buffer<span class="token punctuation">(</span><span class="token string">'pos_embedding'</span><span class="token punctuation">,</span> pos_embedding<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> token_embedding<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        前向传播方法，将位置编码添加到词嵌入上。
        
        参数:
        - token_embedding: 输入的词嵌入张量
        """</span>
        <span class="token comment"># 将位置编码添加到词嵌入上，并应用Dropout</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>token_embedding <span class="token operator">+</span> self<span class="token punctuation">.</span>pos_embedding<span class="token punctuation">[</span><span class="token punctuation">:</span>token_embedding<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">TokenEmbedding</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    词嵌入层，将词汇表中的索引转换为固定长度的向量表示。
    
    参数:
    - vocab_size: 词汇表大小
    - emb_size: 词嵌入维度
    """</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> vocab_size<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> emb_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>TokenEmbedding<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 初始化一个词嵌入层</span>
        self<span class="token punctuation">.</span>embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">(</span>vocab_size<span class="token punctuation">,</span> emb_size<span class="token punctuation">)</span>
        <span class="token comment"># 记录词嵌入维度，用于后续计算</span>
        self<span class="token punctuation">.</span>emb_size <span class="token operator">=</span> emb_size
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tokens<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        前向传播方法，根据输入的词索引返回词嵌入，并乘以词嵌入维度的平方根进行缩放。
        
        参数:
        - tokens: 输入的词索引张量
        """</span>
        <span class="token comment"># 获取词嵌入并按emb_size的平方根进行缩放，这是一种常见的缩放策略</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>embedding<span class="token punctuation">(</span>tokens<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>emb_size<span class="token punctuation">)</span>
</code></pre>
<p>我们还创建了一个后续词掩码（subsequent word mask），用以阻止目标词关注其后面的词，这是为了避免模型在预测时“看到未来”的信息。同时，我们还创建了源语言和目标语言的填充标记掩码，用来在计算注意力权重时忽略掉那些用于填充的标记，确保模型专注于实际有效的输入信息。</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> torch

<span class="token keyword">def</span> <span class="token function">generate_square_subsequent_mask</span><span class="token punctuation">(</span>sz<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    生成一个上三角的掩码矩阵，用于屏蔽后续时间步的值，常用于自回归模型中。
    
    参数:
    - sz: 掩码矩阵的尺寸，即序列的最大长度
    
    返回:
    - 一个上三角掩码矩阵，其中上三角为0（或-inf），对角线及以下为1（或0）。
    """</span>
    <span class="token comment"># 创建一个上三角矩阵，其中1位于上三角，0位于下三角</span>
    mask <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>triu<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token punctuation">(</span>sz<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 将0变为-inf，1保持不变，以便在softmax操作中将后续时间步的注意力得分设为极小值</span>
    mask <span class="token operator">=</span> mask<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> mask

<span class="token keyword">def</span> <span class="token function">create_mask</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> tgt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    创建源序列(src)和目标序列(tgt)所需的掩码，包括：
    - 自回归掩码（tgt_mask）：确保解码器只关注过去的输出。
    - 源序列掩码（src_mask）：通常全为False，除非有特定的序列间遮挡需求。
    - 源序列填充掩码（src_padding_mask）：标识src中padding位置的掩码。
    - 目标序列填充掩码（tgt_padding_mask）：标识tgt中padding位置的掩码。
    
    参数:
    - src: 源序列的Tensor，形状为(seq_length, batch_size)
    - tgt: 目标序列的Tensor，形状为(seq_length, batch_size)
    
    返回:
    - src_mask, tgt_mask, src_padding_mask, tgt_padding_mask
    """</span>
    src_seq_len <span class="token operator">=</span> src<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    tgt_seq_len <span class="token operator">=</span> tgt<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

    <span class="token comment"># 为目标序列创建自回归掩码</span>
    tgt_mask <span class="token operator">=</span> generate_square_subsequent_mask<span class="token punctuation">(</span>tgt_seq_len<span class="token punctuation">)</span>
    
    <span class="token comment"># 源序列掩码默认情况下全为False，这里直接创建一个全False的布尔掩码</span>
    src_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>src_seq_len<span class="token punctuation">,</span> src_seq_len<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 创建源序列和目标序列的填充掩码，PAD_IDX是预定义的填充标记的索引</span>
    src_padding_mask <span class="token operator">=</span> <span class="token punctuation">(</span>src <span class="token operator">==</span> PAD_IDX<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    tgt_padding_mask <span class="token operator">=</span> <span class="token punctuation">(</span>tgt <span class="token operator">==</span> PAD_IDX<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 返回所有类型的掩码</span>
    <span class="token keyword">return</span> src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">,</span> src_padding_mask<span class="token punctuation">,</span> tgt_padding_mask
</code></pre>
<p>Define model parameters and instantiate model. 这里我们服务器实在是计算能力有限，按照以下配置可以训练但是效果应该是不行的。如果想要看到训练的效果请使用你自己的带GPU的电脑运行这一套代码。</p>
<p>当你使用自己的GPU的时候，NUM_ENCODER_LAYERS 和 NUM_DECODER_LAYERS 设置为3或者更高，NHEAD设置8，EMB_SIZE设置为512。</p>
<h3><a id="355__698"></a>3.5.5 设计超参数及模型评估函数</h3>
<pre><code class="prism language-python"><span class="token comment"># 设计超参数及模型评估函数</span>
SRC_VOCAB_SIZE <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ja_vocab<span class="token punctuation">)</span>  <span class="token comment"># 日语词汇表的大小</span>
TGT_VOCAB_SIZE <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>en_vocab<span class="token punctuation">)</span>  <span class="token comment"># 英语词汇表的大小</span>
EMB_SIZE <span class="token operator">=</span> <span class="token number">512</span>  <span class="token comment"># 嵌入维度大小</span>
NHEAD <span class="token operator">=</span> <span class="token number">8</span>  <span class="token comment"># 多头注意力机制中的头数</span>
FFN_HID_DIM <span class="token operator">=</span> <span class="token number">512</span>  <span class="token comment"># 前馈神经网络隐藏层的维度</span>
BATCH_SIZE <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment"># 批量大小</span>
NUM_ENCODER_LAYERS <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment"># 编码器层数量</span>
NUM_DECODER_LAYERS <span class="token operator">=</span> <span class="token number">3</span>  <span class="token comment"># 解码器层数量</span>
NUM_EPOCHS <span class="token operator">=</span> <span class="token number">16</span>  <span class="token comment"># 训练轮数</span>

<span class="token comment"># 初始化Seq2SeqTransformer模型</span>
transformer <span class="token operator">=</span> Seq2SeqTransformer<span class="token punctuation">(</span>NUM_ENCODER_LAYERS<span class="token punctuation">,</span> NUM_DECODER_LAYERS<span class="token punctuation">,</span>
                                 EMB_SIZE<span class="token punctuation">,</span> SRC_VOCAB_SIZE<span class="token punctuation">,</span> TGT_VOCAB_SIZE<span class="token punctuation">,</span>
                                 FFN_HID_DIM<span class="token punctuation">)</span>

<span class="token comment"># 使用Xavier初始化方法初始化模型参数</span>
<span class="token keyword">for</span> p <span class="token keyword">in</span> transformer<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> p<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>  <span class="token comment"># 只对多维参数（通常是权重矩阵）应用初始化</span>
        nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>xavier_uniform_<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

<span class="token comment"># 将模型移至指定设备（如GPU）</span>
transformer <span class="token operator">=</span> transformer<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

<span class="token comment"># 定义损失函数，忽略PAD_IDX位置的损失</span>
loss_fn <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span>ignore_index<span class="token operator">=</span>PAD_IDX<span class="token punctuation">)</span>

<span class="token comment"># 设置Adam优化器</span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>
    transformer<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.0001</span><span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.9</span><span class="token punctuation">,</span> <span class="token number">0.98</span><span class="token punctuation">)</span><span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">1e-9</span>
<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">train_epoch</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""训练模型一个epoch"""</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置模型为训练模式</span>
    losses <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 初始化损失总和</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>src<span class="token punctuation">,</span> tgt<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 遍历训练数据迭代器</span>
        src<span class="token punctuation">,</span> tgt <span class="token operator">=</span> src<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> tgt<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 将数据移至设备</span>
        tgt_input <span class="token operator">=</span> tgt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 移除最后一个目标词作为预测的起始</span>
        
        <span class="token comment"># 为当前批次创建掩码</span>
        src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">,</span> src_padding_mask<span class="token punctuation">,</span> tgt_padding_mask <span class="token operator">=</span> create_mask<span class="token punctuation">(</span>src<span class="token punctuation">,</span> tgt_input<span class="token punctuation">)</span>
        
        <span class="token comment"># 前向传播获取logits</span>
        logits <span class="token operator">=</span> model<span class="token punctuation">(</span>src<span class="token punctuation">,</span> tgt_input<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">,</span>
                       src_padding_mask<span class="token punctuation">,</span> tgt_padding_mask<span class="token punctuation">,</span> src_padding_mask<span class="token punctuation">)</span>
        
        <span class="token comment"># 清零梯度</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 计算损失，仅对除了PAD之外的位置</span>
        tgt_out <span class="token operator">=</span> tgt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 移除第一个词，与logits对应</span>
        loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>logits<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> logits<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tgt_out<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 反向传播并更新权重</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        losses <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 累加损失</span>
    <span class="token keyword">return</span> losses <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_iter<span class="token punctuation">)</span>  <span class="token comment"># 返回平均损失</span>

<span class="token keyword">def</span> <span class="token function">evaluate</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> val_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""评估模型在一个验证集上的性能"""</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置模型为评估模式</span>
    losses <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 初始化损失总和</span>
    <span class="token keyword">for</span> idx<span class="token punctuation">,</span> <span class="token punctuation">(</span>src<span class="token punctuation">,</span> tgt<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>valid_iter<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 遍历验证数据迭代器</span>
        src<span class="token punctuation">,</span> tgt <span class="token operator">=</span> src<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> tgt<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 移动数据到设备</span>
        tgt_input <span class="token operator">=</span> tgt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 截取用于预测的部分</span>
        
        <span class="token comment"># 创建掩码</span>
        src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">,</span> src_padding_mask<span class="token punctuation">,</span> tgt_padding_mask <span class="token operator">=</span> create_mask<span class="token punctuation">(</span>src<span class="token punctuation">,</span> tgt_input<span class="token punctuation">)</span>
        
        <span class="token comment"># 获取模型的预测logits</span>
        logits <span class="token operator">=</span> model<span class="token punctuation">(</span>src<span class="token punctuation">,</span> tgt_input<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">,</span>
                       src_padding_mask<span class="token punctuation">,</span> tgt_padding_mask<span class="token punctuation">,</span> src_padding_mask<span class="token punctuation">)</span>
        
        <span class="token comment"># 计算损失</span>
        tgt_out <span class="token operator">=</span> tgt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 移除第一个词，与logits对齐</span>
        loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>logits<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> logits<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tgt_out<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        losses <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 累加损失</span>
    <span class="token keyword">return</span> losses <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>val_iter<span class="token punctuation">)</span>  <span class="token comment"># 返回平均损失</span>
</code></pre>
<h3><a id="356__785"></a>3.5.6 开始训练模型及使用模型完成翻译任务</h3>
<p>在准备好所有必需的类和函数后，我们就能够开始训练模型了。不言而喻，完成训练所需的时间会根据多种因素大幅波动，比如计算能力、模型参数以及数据集的大小。</p>
<p>当我使用JParaCrawl完整语料库训练模型时，每种语言大约有590万条句子，仅依靠一块NVIDIA GeForce RTX 3070 GPU进行训练，每个epoch大约需要5个小时左右。</p>
<pre><code class="prism language-python"><span class="token keyword">for</span> epoch <span class="token keyword">in</span> tqdm<span class="token punctuation">.</span>tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> NUM_EPOCHS<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
  start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
  train_loss <span class="token operator">=</span> train_epoch<span class="token punctuation">(</span>transformer<span class="token punctuation">,</span> train_iter<span class="token punctuation">,</span> optimizer<span class="token punctuation">)</span>
  end_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 记录训练过程所花费的时间</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Epoch: </span><span class="token interpolation"><span class="token punctuation">{</span>epoch<span class="token punctuation">}</span></span><span class="token string">, Train loss: </span><span class="token interpolation"><span class="token punctuation">{</span>train_loss<span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">, "</span></span>
          <span class="token string-interpolation"><span class="token string">f"Epoch time = </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token punctuation">(</span>end_time <span class="token operator">-</span> start_time<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.3f</span><span class="token punctuation">}</span></span><span class="token string">s"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<p>首先，我们需要创建一系列函数来翻译一个新的日语句子，这一过程包括几个步骤：获取日语句子、进行分词处理、将分词结果转换为张量形式、利用训练好的模型进行推断，最后将模型输出解码回英语句子。</p>
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">greedy_decode</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> src<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> max_len<span class="token punctuation">,</span> start_symbol<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    贪婪解码方法，基于已训练好的模型生成翻译序列。
    
    参数:
    - model: 训练好的Seq2SeqTransformer模型
    - src: 源语言句子的Tensor表示
    - src_mask: 源语言句子的掩码
    - max_len: 生成序列的最大长度
    - start_symbol: 目标语言序列开始的符号索引
    
    返回:
    - 生成的目标语言句子的token索引序列
    """</span>
    src <span class="token operator">=</span> src<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 确保源序列在指定设备上</span>
    src_mask <span class="token operator">=</span> src_mask<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 确保源序列掩码也在指定设备上</span>
    <span class="token comment"># 编码源序列</span>
    memory <span class="token operator">=</span> model<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>src<span class="token punctuation">,</span> src_mask<span class="token punctuation">)</span>
    <span class="token comment"># 初始化目标序列，以开始符号&lt;BOS&gt;</span>
    ys <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fill_<span class="token punctuation">(</span>start_symbol<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">long</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>max_len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        memory <span class="token operator">=</span> memory<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 确保内存（编码输出）在设备上</span>
        <span class="token comment"># 为解码器创建一个掩码，初始阶段目标序列只有一个元素</span>
        memory_mask <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>ys<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> memory<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
        <span class="token comment"># 创建解码器自注意力的掩码</span>
        tgt_mask <span class="token operator">=</span> <span class="token punctuation">(</span>generate_square_subsequent_mask<span class="token punctuation">(</span>ys<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                                    <span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        <span class="token comment"># 解码一步</span>
        out <span class="token operator">=</span> model<span class="token punctuation">.</span>decode<span class="token punctuation">(</span>ys<span class="token punctuation">,</span> memory<span class="token punctuation">,</span> tgt_mask<span class="token punctuation">)</span>
        <span class="token comment"># 调整输出形状以匹配后续操作</span>
        out <span class="token operator">=</span> out<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># 通过生成器获取下一个词的概率分布</span>
        prob <span class="token operator">=</span> model<span class="token punctuation">.</span>generator<span class="token punctuation">(</span>out<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 选择概率最高的词作为下一个词</span>
        _<span class="token punctuation">,</span> next_word <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>prob<span class="token punctuation">,</span> dim <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>
        next_word <span class="token operator">=</span> next_word<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 转换为Python数值</span>
        <span class="token comment"># 将选择的词添加到目标序列中</span>
        ys <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">[</span>ys<span class="token punctuation">,</span>
                        torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>type_as<span class="token punctuation">(</span>src<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>fill_<span class="token punctuation">(</span>next_word<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token comment"># 如果遇到&lt;EOS&gt;符号则停止生成</span>
        <span class="token keyword">if</span> next_word <span class="token operator">==</span> EOS_IDX<span class="token punctuation">:</span>
            <span class="token keyword">break</span>
    <span class="token keyword">return</span> ys  <span class="token comment"># 返回生成的序列</span>

<span class="token keyword">def</span> <span class="token function">translate</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> src<span class="token punctuation">,</span> src_vocab<span class="token punctuation">,</span> tgt_vocab<span class="token punctuation">,</span> src_tokenizer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    使用贪婪解码方法对单个源语言句子进行翻译。
    
    参数:
    - model: 训练好的Seq2SeqTransformer模型
    - src: 源语言句子的文本
    - src_vocab: 源语言词汇表
    - tgt_vocab: 目标语言词汇表
    - src_tokenizer: 源语言的分词器
    
    返回:
    - 翻译后的目标语言句子文本
    """</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置模型为评估模式</span>
    <span class="token comment"># 对源句子进行编码，添加开始和结束符号</span>
    tokens <span class="token operator">=</span> <span class="token punctuation">[</span>BOS_IDX<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span>src_vocab<span class="token punctuation">.</span>stoi<span class="token punctuation">[</span>tok<span class="token punctuation">]</span> <span class="token keyword">for</span> tok <span class="token keyword">in</span> src_tokenizer<span class="token punctuation">.</span>encode<span class="token punctuation">(</span>src<span class="token punctuation">,</span> out_type<span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">+</span> <span class="token punctuation">[</span>EOS_IDX<span class="token punctuation">]</span>
    num_tokens <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span>  <span class="token comment"># 计算序列长度</span>
    src <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>tokens<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>num_tokens<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token comment"># 转换为Tensor</span>
    src_mask <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>num_tokens<span class="token punctuation">,</span> num_tokens<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">type</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span><span class="token builtin">bool</span><span class="token punctuation">)</span>  <span class="token comment"># 创建掩码</span>
    <span class="token comment"># 使用贪婪解码生成目标序列</span>
    tgt_tokens <span class="token operator">=</span> greedy_decode<span class="token punctuation">(</span>model<span class="token punctuation">,</span> src<span class="token punctuation">,</span> src_mask<span class="token punctuation">,</span> max_len<span class="token operator">=</span>num_tokens <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">,</span> start_symbol<span class="token operator">=</span>BOS_IDX<span class="token punctuation">)</span><span class="token punctuation">.</span>flatten<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 将生成的token索引序列转换为目标语言的文本</span>
    <span class="token keyword">return</span> <span class="token string">" "</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span><span class="token punctuation">[</span>tgt_vocab<span class="token punctuation">.</span>itos<span class="token punctuation">[</span>tok<span class="token punctuation">]</span> <span class="token keyword">for</span> tok <span class="token keyword">in</span> tgt_tokens<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;bos&gt;"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">"&lt;eos&gt;"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
</code></pre>
<p>然后，我们只需调用translate函数并传入所需的参数即可。</p>
<pre><code class="prism language-python">translate<span class="token punctuation">(</span>transformer<span class="token punctuation">,</span> <span class="token string">"HSコード 8515 はんだ付け用、ろう付け用又は溶接用の機器(電気式(電気加熱ガス式を含む。)"</span><span class="token punctuation">,</span> ja_vocab<span class="token punctuation">,</span> en_vocab<span class="token punctuation">,</span> ja_tokenizer<span class="token punctuation">)</span>
trainen<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
trainja<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
</code></pre>
<p>翻译结果：<br>
<img src="https://img-blog.csdnimg.cn/direct/75c23e762b094079bca89a474b1193b8.png" alt="在这里插入图片描述"><br>
<img src="https://img-blog.csdnimg.cn/direct/4875f067eb7a4247ba3df81a669cfd71.png" alt="在这里插入图片描述"><img src="https://img-blog.csdnimg.cn/direct/4f17d48bc34d4671afb32e201b9ee5f0.png" alt="在这里插入图片描述"></p>
<h3><a id="357__881"></a>3.5.7 保存训练好的模型及词汇表对象</h3>
<p>在训练完成后，我们首先需要保存词汇表对象（en_vocab和ja_vocab）以及训练好的模型，以备后续使用。这里我们使用Pickle库来完成这一操作。Pickle是一个Python标准库，能够将Python对象转化为字节流（即序列化过程），方便存储至文件或在网络间传输。</p>
<pre><code class="prism language-python"><span class="token keyword">import</span> pickle
<span class="token comment"># 打开存储数据的文件</span>
<span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'en_vocab.pkl'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span>
<span class="token comment"># dump information to that file</span>
pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>en_vocab<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>
<span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token builtin">file</span> <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'ja_vocab.pkl'</span><span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span>
pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>ja_vocab<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span>
<span class="token builtin">file</span><span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>最后，我们还能使用PyTorch的保存和加载功能来保存模型以备后续使用。通常，根据后续使用的不同需求，有两种保存模型的方法。第一种是仅用于推理，即之后我们可以加载模型，直接使用它来进行日语到英语的翻译。</p>
<pre><code class="prism language-python"><span class="token comment"># 保存模型</span>
torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>transformer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'inference_model'</span><span class="token punctuation">)</span>
</code></pre>
<p>第二种情况也是为了推理，但同时适用于我们希望在之后加载模型并继续训练的情况。在这种情形下，除了保存模型的参数状态之外，通常还需要保存额外的训练状态信息，如优化器的状态、训练的轮次（epoch）以及其他可能影响训练连续性的参数。</p>
<pre><code class="prism language-python"><span class="token comment"># 保存模型及检查点以便后续继续训练</span>
torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token string">'epoch'</span><span class="token punctuation">:</span> NUM_EPOCHS<span class="token punctuation">,</span>  <span class="token comment"># 当前训练的轮数</span>
  <span class="token string">'model_state_dict'</span><span class="token punctuation">:</span> transformer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 模型的参数状态字典</span>
  <span class="token string">'optimizer_state_dict'</span><span class="token punctuation">:</span> optimizer<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 优化器的状态字典，包括学习率等超参数</span>
  <span class="token string">'loss'</span><span class="token punctuation">:</span> train_loss<span class="token punctuation">,</span>  <span class="token comment"># 训练损失值，记录训练时的损失情况</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">'model_checkpoint.tar'</span><span class="token punctuation">)</span>  <span class="token comment"># 将上述所有信息保存至'model_checkpoint.tar'文件中</span>
</code></pre>
<p>实验14结束！</p>
<h1><a id="_913"></a>四.实验总结与思考</h1>
<h2><a id="41__915"></a>4.1 实验结果</h2>
<ul>
<li>训练表现：模型训练损失逐渐下降，表明模型在不断学习输入与输出序列之间的映射关系。</li>
<li>测试表现：在一些简单的句子上，模型能够生成较为准确的翻译结果。但在复杂句子上，模型有时会生成不完整或不准确的翻译。</li>
</ul>
<h2><a id="42__918"></a>4.2 思考与改进</h2>
<h3><a id="421__919"></a>4.2.1 模型改进：</h3>
<ul>
<li>注意力机制：可以尝试更复杂的注意力机制，如多头注意力（Multi-Head Attention），以提升模型对长序列的处理能力。</li>
<li>预训练模型：使用预训练的Transformer模型（如BERT、GPT）作为编码器和解码器，可以显著提高翻译效果。</li>
</ul>
<h3><a id="422__923"></a>4.2.2 数据处理：</h3>
<ul>
<li>数据增强：通过数据增强技术（如同义词替换、随机插入、随机删除等），增加训练数据的多样性，有助于提升模型的泛化能力。</li>
<li>更多语料：使用更多的平行语料进行训练，特别是包含复杂句子的语料，可以提高模型在复杂句子上的表现。</li>
</ul>
<h3><a id="423__927"></a>4.2.3 训练策略：</h3>
<ul>
<li>混合策略：在训练初期使用逐步解码策略（Teacher Forcing），在训练后期逐步减少Teacher Forcing的比例，让模型更多地依赖自身生成的输出，提升推理时的鲁棒性。</li>
<li>调参实验：调整模型的超参数（如LSTM单元数、学习率、批量大小等），通过实验找到最优配置。<br>
评估与测试：</li>
<li>多维度评估：不仅评估模型在单个句子上的翻译效果，还可以使用BLEU、ROUGE等指标进行全面评估。<br>
错误分析：分析模型翻译错误的类型（如词汇错误、语法错误、遗漏等），针对性地改进模型。</li>
</ul>
<p><strong>结论</strong><br>
通过实验，我们验证了基于注意力机制的编码器-解码器模型在机器翻译任务上的有效性。尽管模型在简单句子上的表现较好，但在复杂句子上仍有改进空间。通过引入更先进的注意力机制、预训练模型以及更丰富的数据和训练策略，可以进一步提升模型的翻译效果。总之，机器翻译是一个复杂的任务，需要综合考虑模型架构、数据处理、训练策略等多方面因素，才能不断逼近理想的翻译效果。</p>

    </div>
  </div>
</body>

</html>
